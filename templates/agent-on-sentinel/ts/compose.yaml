# Docker Compose for agent-on-sentinel starter
#
# Starts a sentinel hosting the EchoAgent, plus a one-shot client service.
#
# Usage:
#   docker compose up -d agent     # Start sentinel+agent
#   docker compose run --rm client # Run client once
#   docker compose down            # Stop everything

x-config: &config
  version: &base-version "0.3.17"
  base-image: &base-image naylence/agent-sdk-node:0.3.17

services:
  # Sentinel + EchoAgent (long-running service)
  agent:
    image: *base-image
    command: ["node", "--enable-source-maps", "echo-agent.mjs"]
    working_dir: /app
    ports:
      - "${FAME_LISTENER_PORT:-8000}:8000"
    env_file:
      - .env.agent
    environment:
      NODE_ENV: production
      FAME_LOG_LEVEL: ${FAME_LOG_LEVEL:-info}
      FAME_SHOW_ENVELOPES: ${FAME_SHOW_ENVELOPES:-false}
      FAME_LISTENER_PORT: ${FAME_LISTENER_PORT:-8000}
    volumes:
      # Mount compiled JavaScript
      - ./dist:/app
      # Preserve node_modules from the base image
      - /app/node_modules
    restart: unless-stopped
    networks:
      - naylence-net
    healthcheck:
      test: ["CMD-SHELL", "node -e \"const net = require('net'); const port = process.env.FAME_LISTENER_PORT || 8000; const s = net.connect(port, 'localhost', () => s.end());\""]
      interval: 1s
      timeout: 2s
      retries: 30
      start_period: 2s

  # CLI Client (one-shot)
  client:
    image: *base-image
    command: ["node", "--enable-source-maps", "client.mjs"]
    working_dir: /app
    env_file:
      - .env.client
    environment:
      NODE_ENV: production
      FAME_LOG_LEVEL: ${FAME_LOG_LEVEL:-info}
      FAME_SHOW_ENVELOPES: ${FAME_SHOW_ENVELOPES:-false}
      FAME_LISTENER_PORT: ${FAME_LISTENER_PORT:-8000}
      # Override for Docker networking (container-to-container)
      FAME_DIRECT_ADMISSION_URL: ws://agent:${FAME_LISTENER_PORT:-8000}/fame/v1/attach/ws/downstream
    volumes:
      - ./dist:/app
      - /app/node_modules
    depends_on:
      agent:
        condition: service_healthy
    networks:
      - naylence-net

networks:
  naylence-net:
    driver: bridge
